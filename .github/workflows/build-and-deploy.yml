name: CI/CD Process
on:
  workflow_call:
    inputs:
      release:
        required: false
        type: string
        default: "false"
  workflow_dispatch:  # Optional, for direct invocation
    inputs:
      release:
        description: 'Trigger a release?'
        required: false
        default: 'false'
jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-24.04, windows-2022, macos-14]
        java-version: [17, 21, 23]
    runs-on: ${{ matrix.os }}
    env:
      ci: true
    steps:
      - name: Checkout
        uses: DanySK/action-checkout@0.2.22
      - name: Set up JDK
        uses: actions/setup-java@v4.7.1
        with:
          distribution: temurin
          java-version: ${{ matrix.java-version }}
          cache: sbt
      - uses: sbt/setup-sbt@v1.1.11
      - name: Build and test
        shell: bash
        run: sbt +test


  code-style:
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout
        uses: DanySK/action-checkout@0.2.22
      - name: Set up JDK
        uses: actions/setup-java@v4.7.1
        with:
          distribution: temurin
          java-version: 21
          cache: sbt
      - uses: sbt/setup-sbt@v1.1.11
      - name: Compile
        shell: bash
        run: sbt compile
      - name: Check formatting
        shell: bash
        run: sbt scalafmtCheckAll
      - name: Run linter
        shell: bash
        run: sbt "scalafixAll --check"

  code-coverage:
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout
        uses: actions/checkout@v4.2.2
        with:
          persist-credentials: false
      - name: Set up JDK
        uses: actions/setup-java@v4.7.1
        with:
          distribution: temurin
          java-version: 21
          cache: sbt
      - uses: sbt/setup-sbt@v1.1.11
      - name: Extract Scala version
        id: scala-version
        run: |
          echo "version=$(sbt 'show scalaVersion' | grep -o '[0-9]\+\.[0-9]\+\.[0-9]\+' | tail -n 1)" >> "$GITHUB_OUTPUT"
      - name: Run Coverage
        run: sbt clean jacoco
      - name: Add coverage to PR
        if: github.ref != 'refs/heads/main'
        id: jacoco
        uses: madrapps/jacoco-report@v1.7.2
        with:
          paths: |
            ${{ github.workspace }}/**/target/scala-${{ steps.scala-version.outputs.version }}/jacoco/report/jacoco.xml
          token: ${{ secrets.GH_TOKEN }}
          update-comment: true
          title: Coverage report
      - name: Upload coverage to Coveralls
        env:
          COVERALLS_REPO_TOKEN: ${{ secrets.COVERALLS_REPO_TOKEN }}
        run: |
          export CI_BRANCH="${GITHUB_REF#refs/heads/}"
          sbt clean jacoco jacocoCoveralls

