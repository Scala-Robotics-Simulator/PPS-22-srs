"use strict";(self.webpackChunkdocs=self.webpackChunkdocs||[]).push([[8851],{8453:(e,i,n)=>{n.d(i,{R:()=>o,x:()=>r});var a=n(6540);const l={},s=a.createContext(l);function o(e){const i=a.useContext(s);return a.useMemo(function(){return"function"==typeof e?e(i):{...i,...e}},[i,e])}function r(e){let i;return i=e.disableParentContext?"function"==typeof e.components?e.components(l):e.components||l:o(e.components),a.createElement(s.Provider,{value:i},e.children)}},9300:(e,i,n)=>{n.r(i),n.d(i,{assets:()=>c,contentTitle:()=>r,default:()=>m,frontMatter:()=>o,metadata:()=>a,toc:()=>t});const a=JSON.parse('{"id":"detailed-design/illumination","title":"Illumination","description":"Il sottosistema di illumination \xe8 responsabile del calcolo di un campo di luce (LightField) discreto","source":"@site/docs/04-detailed-design/09-illumination.md","sourceDirName":"04-detailed-design","slug":"/detailed-design/illumination","permalink":"/PPS-22-srs/docs/detailed-design/illumination","draft":false,"unlisted":false,"tags":[],"version":"current","sidebarPosition":9,"frontMatter":{"sidebar_position":9},"sidebar":"docsSidebar","previous":{"title":"Configuration","permalink":"/PPS-22-srs/docs/detailed-design/configuration"},"next":{"title":"Generatore di numeri casuali","permalink":"/PPS-22-srs/docs/detailed-design/random-number-generator"}}');var l=n(4848),s=n(8453);const o={sidebar_position:9},r="Illumination",c={},t=[{value:"Pipeline computazionale",id:"pipeline-computazionale",level:2},{value:"Componenti principali",id:"componenti-principali",level:2},{value:"Tagless final pattern",id:"tagless-final-pattern",level:2},{value:"Scelte di design",id:"scelte-di-design",level:2},{value:"Rappresentazione a griglia (grid-based)",id:"rappresentazione-a-griglia-grid-based",level:3},{value:"Mappa di occlusione",id:"mappa-di-occlusione",level:3},{value:"Propagazione della luce indipendente (per-light FOV)",id:"propagazione-della-luce-indipendente-per-light-fov",level:3},{value:"Combinazione dei contributi",id:"combinazione-dei-contributi",level:3},{value:"Parallelizzazione \u201cadattiva\u201d",id:"parallelizzazione-adattiva",level:3},{value:"Interrogazione del campo con interpolazione",id:"interrogazione-del-campo-con-interpolazione",level:3},{value:"Integrazione con <code>Environment</code>",id:"integrazione-con-environment",level:3}];function d(e){const i={a:"a",admonition:"admonition",annotation:"annotation",blockquote:"blockquote",code:"code",em:"em",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",math:"math",mi:"mi",mn:"mn",mo:"mo",mrow:"mrow",ol:"ol",p:"p",semantics:"semantics",span:"span",strong:"strong",ul:"ul",...(0,s.R)(),...e.components};return(0,l.jsxs)(l.Fragment,{children:[(0,l.jsx)(i.header,{children:(0,l.jsx)(i.h1,{id:"illumination",children:"Illumination"})}),"\n",(0,l.jsxs)(i.p,{children:["Il sottosistema di ",(0,l.jsx)(i.strong,{children:"illumination"})," \xe8 responsabile del calcolo di un ",(0,l.jsx)(i.strong,{children:"campo di luce"})," (",(0,l.jsx)(i.code,{children:"LightField"}),") discreto\nall'interno dell'ambiente di simulazione. L'approccio fondamentale consiste nel:"]}),"\n",(0,l.jsxs)(i.ul,{children:["\n",(0,l.jsxs)(i.li,{children:[(0,l.jsx)(i.em,{children:"discretizzare"})," lo spazio in una griglia;"]}),"\n",(0,l.jsxs)(i.li,{children:["stimare l'intensit\xe0 luminosa in ogni cella tenendo conto di ",(0,l.jsx)(i.strong,{children:"ostacoli"}),", raggio delle sorgenti\ne, opzionalmente, i ",(0,l.jsx)(i.strong,{children:"robot"}),";"]}),"\n",(0,l.jsx)(i.li,{children:"combinare i contributi di tutte le luci in un unico campo luminoso."}),"\n"]}),"\n",(0,l.jsxs)(i.p,{children:["Questo permette ai sensori e ad altri componenti della simulazione di interrogare l'intensit\xe0 luminosa in\n",(0,l.jsx)(i.em,{children:"qualsiasi punto"})," dello spazio."]}),"\n",(0,l.jsx)(i.h2,{id:"pipeline-computazionale",children:"Pipeline computazionale"}),"\n",(0,l.jsx)(i.p,{children:"Il calcolo segue una pipeline ben definita in tre fasi:"}),"\n",(0,l.jsxs)(i.ol,{children:["\n",(0,l.jsxs)(i.li,{children:[(0,l.jsx)(i.strong,{children:"rasterizzazione delle occlusioni"}),": le entit\xe0 geometriche che proiettano ombre (ostacoli, e opzionalmente i robot)\nvengono convertite in una griglia discreta di valori di occlusione (",(0,l.jsx)(i.code,{children:"0.0"})," = trasparente, ",(0,l.jsx)(i.code,{children:"1.0"})," = opaco);"]}),"\n",(0,l.jsxs)(i.li,{children:[(0,l.jsx)(i.strong,{children:"calcolo del Field-of-View (FOV)"}),": per ogni sorgente luminosa, viene calcolata la propagazione della luce. Un\nmotore di Field-of-View (FOV) determina quali celle sono visibili dalla sorgente, tenendo conto della mappa di\nocclusione;"]}),"\n",(0,l.jsxs)(i.li,{children:[(0,l.jsx)(i.strong,{children:"combinazione dei campi luminosi"}),": i contributi di ogni sorgente luminosa vengono aggregati in un unico\ncampo luminoso finale, utilizzando una tecnica di somma saturata per mantenere i valori nel range ",(0,l.jsx)(i.code,{children:"[0, 1]"}),"."]}),"\n"]}),"\n",(0,l.jsx)(i.h2,{id:"componenti-principali",children:"Componenti principali"}),"\n",(0,l.jsxs)(i.ul,{children:["\n",(0,l.jsxs)(i.li,{children:[(0,l.jsx)(i.strong,{children:(0,l.jsx)(i.code,{children:"LightMap"})}),": la ",(0,l.jsx)(i.em,{children:"facade pubblica"})," del sistema. Incapsula la configurazione (es.\n",(0,l.jsx)(i.code,{children:"ScaleFactor"}),") e offre preset per bilanciare qualit\xe0 e performance."]}),"\n",(0,l.jsxs)(i.li,{children:[(0,l.jsx)(i.strong,{children:(0,l.jsx)(i.code,{children:"IlluminationLogic"})}),": l'",(0,l.jsx)(i.em,{children:"orchestratore"})," della pipeline. Calcola l\u2019occlusione, ricorre al FOV per\nogni luce e combina i risultati decidendo se parallelizzare il calcolo."]}),"\n",(0,l.jsxs)(i.li,{children:[(0,l.jsx)(i.strong,{children:(0,l.jsx)(i.code,{children:"OcclusionRaster"})}),": converte le ",(0,l.jsx)(i.em,{children:"geometrie"})," (cerchi, rettangoli) in una mappa di occlusione su griglia."]}),"\n",(0,l.jsxs)(i.li,{children:[(0,l.jsx)(i.strong,{children:(0,l.jsx)(i.code,{children:"FovEngine"})}),": un'interfaccia ",(0,l.jsx)(i.em,{children:"pluggable"})," per gli algoritmi di propagazione della luce. L'implementazione attuale usa\n",(0,l.jsx)(i.a,{href:"https://github.com/yellowstonegames/SquidLib",children:"SquidLib"}),"."]}),"\n",(0,l.jsxs)(i.li,{children:[(0,l.jsx)(i.strong,{children:(0,l.jsx)(i.code,{children:"LightField"})}),": la ",(0,l.jsx)(i.em,{children:"struttura dati finale"})," che rappresenta il campo luminoso, interrogabile in coordinate continue\ntramite ",(0,l.jsx)(i.em,{children:"interpolazione bilineare"}),"."]}),"\n"]}),"\n",(0,l.jsx)(i.h2,{id:"tagless-final-pattern",children:"Tagless final pattern"}),"\n",(0,l.jsxs)(i.p,{children:[(0,l.jsx)(i.code,{children:"LightMap"})," \xe8 modellato come un\u2019algebra parametrica sull\u2019effetto ",(0,l.jsx)(i.code,{children:"F[_]"}),". Questo permette di avere:"]}),"\n",(0,l.jsxs)(i.ul,{children:["\n",(0,l.jsxs)(i.li,{children:[(0,l.jsx)(i.strong,{children:"astrazione dall\u2019effetto"}),": attualmente usiamo ",(0,l.jsx)(i.code,{children:"IO"}),", ma potremmo passare a ",(0,l.jsx)(i.code,{children:"Either"})," o ",(0,l.jsx)(i.code,{children:"Future"})," senza cambiare il core del calcolo;"]}),"\n",(0,l.jsxs)(i.li,{children:[(0,l.jsx)(i.strong,{children:"composizione"}),": si integra con combinatori monadici per orchestrare eventuale parallelismo/caching;"]}),"\n",(0,l.jsxs)(i.li,{children:[(0,l.jsx)(i.strong,{children:"testabilit\xe0"}),": nei test si pu\xf2 istanziare un interprete puro (",(0,l.jsx)(i.code,{children:"Id"}),") che restituisce campi predefiniti;"]}),"\n",(0,l.jsxs)(i.li,{children:[(0,l.jsx)(i.strong,{children:"evoluzione futura"}),": se in futuro servissero effetti pi\xf9 complessi (es. logging, error handling), si pu\xf2\npassare a ",(0,l.jsx)(i.code,{children:"EitherT[IO, Error, A]"})," senza cambiare le API pubbliche."]}),"\n"]}),"\n",(0,l.jsxs)(i.blockquote,{children:["\n",(0,l.jsxs)(i.p,{children:["Nota: l'effetto ",(0,l.jsx)(i.code,{children:"F[_]"})," incapsula solo le ",(0,l.jsx)(i.em,{children:"politiche di esecuzione"})," (quando e come eseguirle)."]}),"\n"]}),"\n",(0,l.jsx)(i.h2,{id:"scelte-di-design",children:"Scelte di design"}),"\n",(0,l.jsx)(i.h3,{id:"rappresentazione-a-griglia-grid-based",children:"Rappresentazione a griglia (grid-based)"}),"\n",(0,l.jsxs)(i.p,{children:["Lo spazio continuo \xe8 campionato in una griglia di ",(0,l.jsxs)(i.span,{className:"katex",children:[(0,l.jsx)(i.span,{className:"katex-mathml",children:(0,l.jsx)(i.math,{xmlns:"http://www.w3.org/1998/Math/MathML",children:(0,l.jsxs)(i.semantics,{children:[(0,l.jsxs)(i.mrow,{children:[(0,l.jsx)(i.mi,{children:"w"}),(0,l.jsx)(i.mi,{children:"i"}),(0,l.jsx)(i.mi,{children:"d"}),(0,l.jsx)(i.mi,{children:"t"}),(0,l.jsx)(i.mi,{children:"h"}),(0,l.jsx)(i.mo,{children:"\u2217"}),(0,l.jsx)(i.mi,{children:"s"}),(0,l.jsx)(i.mi,{children:"c"}),(0,l.jsx)(i.mi,{children:"a"}),(0,l.jsx)(i.mi,{children:"l"}),(0,l.jsx)(i.mi,{children:"e"}),(0,l.jsx)(i.mo,{children:"\xd7"}),(0,l.jsx)(i.mi,{children:"h"}),(0,l.jsx)(i.mi,{children:"e"}),(0,l.jsx)(i.mi,{children:"i"}),(0,l.jsx)(i.mi,{children:"g"}),(0,l.jsx)(i.mi,{children:"h"}),(0,l.jsx)(i.mi,{children:"t"}),(0,l.jsx)(i.mo,{children:"\u2217"}),(0,l.jsx)(i.mi,{children:"s"}),(0,l.jsx)(i.mi,{children:"c"}),(0,l.jsx)(i.mi,{children:"a"}),(0,l.jsx)(i.mi,{children:"l"}),(0,l.jsx)(i.mi,{children:"e"})]}),(0,l.jsx)(i.annotation,{encoding:"application/x-tex",children:"width*scale \xd7 height*scale"})]})})}),(0,l.jsxs)(i.span,{className:"katex-html","aria-hidden":"true",children:[(0,l.jsxs)(i.span,{className:"base",children:[(0,l.jsx)(i.span,{className:"strut",style:{height:"0.6944em"}}),(0,l.jsx)(i.span,{className:"mord mathnormal",style:{marginRight:"0.02691em"},children:"w"}),(0,l.jsx)(i.span,{className:"mord mathnormal",children:"i"}),(0,l.jsx)(i.span,{className:"mord mathnormal",children:"d"}),(0,l.jsx)(i.span,{className:"mord mathnormal",children:"t"}),(0,l.jsx)(i.span,{className:"mord mathnormal",children:"h"}),(0,l.jsx)(i.span,{className:"mspace",style:{marginRight:"0.2222em"}}),(0,l.jsx)(i.span,{className:"mbin",children:"\u2217"}),(0,l.jsx)(i.span,{className:"mspace",style:{marginRight:"0.2222em"}})]}),(0,l.jsxs)(i.span,{className:"base",children:[(0,l.jsx)(i.span,{className:"strut",style:{height:"0.7778em",verticalAlign:"-0.0833em"}}),(0,l.jsx)(i.span,{className:"mord mathnormal",children:"sc"}),(0,l.jsx)(i.span,{className:"mord mathnormal",children:"a"}),(0,l.jsx)(i.span,{className:"mord mathnormal",style:{marginRight:"0.01968em"},children:"l"}),(0,l.jsx)(i.span,{className:"mord mathnormal",children:"e"}),(0,l.jsx)(i.span,{className:"mspace",style:{marginRight:"0.2222em"}}),(0,l.jsx)(i.span,{className:"mbin",children:"\xd7"}),(0,l.jsx)(i.span,{className:"mspace",style:{marginRight:"0.2222em"}})]}),(0,l.jsxs)(i.span,{className:"base",children:[(0,l.jsx)(i.span,{className:"strut",style:{height:"0.8889em",verticalAlign:"-0.1944em"}}),(0,l.jsx)(i.span,{className:"mord mathnormal",children:"h"}),(0,l.jsx)(i.span,{className:"mord mathnormal",children:"e"}),(0,l.jsx)(i.span,{className:"mord mathnormal",children:"i"}),(0,l.jsx)(i.span,{className:"mord mathnormal",style:{marginRight:"0.03588em"},children:"g"}),(0,l.jsx)(i.span,{className:"mord mathnormal",children:"h"}),(0,l.jsx)(i.span,{className:"mord mathnormal",children:"t"}),(0,l.jsx)(i.span,{className:"mspace",style:{marginRight:"0.2222em"}}),(0,l.jsx)(i.span,{className:"mbin",children:"\u2217"}),(0,l.jsx)(i.span,{className:"mspace",style:{marginRight:"0.2222em"}})]}),(0,l.jsxs)(i.span,{className:"base",children:[(0,l.jsx)(i.span,{className:"strut",style:{height:"0.6944em"}}),(0,l.jsx)(i.span,{className:"mord mathnormal",children:"sc"}),(0,l.jsx)(i.span,{className:"mord mathnormal",children:"a"}),(0,l.jsx)(i.span,{className:"mord mathnormal",style:{marginRight:"0.01968em"},children:"l"}),(0,l.jsx)(i.span,{className:"mord mathnormal",children:"e"})]})]})]})," celle. La ",(0,l.jsx)(i.em,{children:"risoluzione"})," \xe8 controllata\nda una scala ",(0,l.jsx)(i.code,{children:"ScaleFactor"})," (celle per metro). Un valore pi\xf9 alto aumenta la qualit\xe0 delle ombre e dei\ndettagli, ma incrementa anche il costo computazionale."]}),"\n",(0,l.jsxs)(i.blockquote,{children:["\n",(0,l.jsx)(i.p,{children:'Nota: l\'accuratezza dipende dalla risoluzione. A scale basse, i contorni delle ombre possono apparire "sgranati"\n(aliasing).'}),"\n"]}),"\n",(0,l.jsx)(i.h3,{id:"mappa-di-occlusione",children:"Mappa di occlusione"}),"\n",(0,l.jsxs)(i.p,{children:["Prima di calcolare la propagazione della luce, viene generata una mappa di occlusione (",(0,l.jsx)(i.code,{children:"occlusionGrid"}),"). Vengono\nrasterizzati:"]}),"\n",(0,l.jsxs)(i.ul,{children:["\n",(0,l.jsxs)(i.li,{children:[(0,l.jsx)(i.strong,{children:"ostacoli statici"})," (sempre inclusi);"]}),"\n",(0,l.jsxs)(i.li,{children:[(0,l.jsx)(i.strong,{children:"entit\xe0 dinamiche"}),", come robot (inclusione opzionale, utile quando devono proiettare ombre)."]}),"\n"]}),"\n",(0,l.jsx)(i.p,{children:"Le forme geometriche sono convertite in celle occluse tramite algoritmi ottimizzati e cache-friendly (es. Scan-line per\ni cerchi). Questo approccio \xe8 veloce, ma la binarizzazione (0/1) non supporta oggetti semitrasparenti."}),"\n",(0,l.jsx)(i.h3,{id:"propagazione-della-luce-indipendente-per-light-fov",children:"Propagazione della luce indipendente (per-light FOV)"}),"\n",(0,l.jsxs)(i.p,{children:["Ogni sorgente luminosa \xe8 trattata in modo ",(0,l.jsx)(i.em,{children:"indipendente"}),". Un ",(0,l.jsx)(i.code,{children:"FovEngine"})," calcola il contributo di luce per\nuna singola sorgente, rispettando la mappa di occlusione. Questo disaccoppia la logica di propagazione dalla libreria\ndi FOV, rendendo il motore sostituibile."]}),"\n",(0,l.jsxs)(i.blockquote,{children:["\n",(0,l.jsxs)(i.p,{children:["Nota: il ",(0,l.jsx)(i.em,{children:"profilo di decadimento"})," della luce \xe8 determinato dal motore di FOV.\n",(0,l.jsx)(i.code,{children:"Light.intensity"})," scala il contributo, mentre ",(0,l.jsx)(i.code,{children:"illuminationRadius"})," limita la portata."]}),"\n"]}),"\n",(0,l.jsx)(i.h3,{id:"combinazione-dei-contributi",children:"Combinazione dei contributi"}),"\n",(0,l.jsxs)(i.p,{children:["I campi luminosi di ogni sorgente sono combinati cella-per-cella tramite una ",(0,l.jsx)(i.em,{children:"somma saturata"})," (",(0,l.jsxs)(i.span,{className:"katex",children:[(0,l.jsx)(i.span,{className:"katex-mathml",children:(0,l.jsx)(i.math,{xmlns:"http://www.w3.org/1998/Math/MathML",children:(0,l.jsxs)(i.semantics,{children:[(0,l.jsxs)(i.mrow,{children:[(0,l.jsx)(i.mi,{children:"m"}),(0,l.jsx)(i.mi,{children:"i"}),(0,l.jsx)(i.mi,{children:"n"}),(0,l.jsx)(i.mo,{stretchy:"false",children:"("}),(0,l.jsx)(i.mi,{children:"a"}),(0,l.jsx)(i.mo,{children:"+"}),(0,l.jsx)(i.mi,{children:"b"}),(0,l.jsx)(i.mo,{separator:"true",children:","}),(0,l.jsx)(i.mn,{children:"1.0"}),(0,l.jsx)(i.mo,{stretchy:"false",children:")"})]}),(0,l.jsx)(i.annotation,{encoding:"application/x-tex",children:"min(a+b, 1.0)"})]})})}),(0,l.jsxs)(i.span,{className:"katex-html","aria-hidden":"true",children:[(0,l.jsxs)(i.span,{className:"base",children:[(0,l.jsx)(i.span,{className:"strut",style:{height:"1em",verticalAlign:"-0.25em"}}),(0,l.jsx)(i.span,{className:"mord mathnormal",children:"min"}),(0,l.jsx)(i.span,{className:"mopen",children:"("}),(0,l.jsx)(i.span,{className:"mord mathnormal",children:"a"}),(0,l.jsx)(i.span,{className:"mspace",style:{marginRight:"0.2222em"}}),(0,l.jsx)(i.span,{className:"mbin",children:"+"}),(0,l.jsx)(i.span,{className:"mspace",style:{marginRight:"0.2222em"}})]}),(0,l.jsxs)(i.span,{className:"base",children:[(0,l.jsx)(i.span,{className:"strut",style:{height:"1em",verticalAlign:"-0.25em"}}),(0,l.jsx)(i.span,{className:"mord mathnormal",children:"b"}),(0,l.jsx)(i.span,{className:"mpunct",children:","}),(0,l.jsx)(i.span,{className:"mspace",style:{marginRight:"0.1667em"}}),(0,l.jsx)(i.span,{className:"mord",children:"1.0"}),(0,l.jsx)(i.span,{className:"mclose",children:")"})]})]})]}),"). Questa\noperazione:"]}),"\n",(0,l.jsxs)(i.ul,{children:["\n",(0,l.jsxs)(i.li,{children:[(0,l.jsx)(i.em,{children:"garantisce"})," che l'intensit\xe0 finale sia sempre nel range ",(0,l.jsx)(i.code,{children:"[0, 1]"}),", ideale per sensori e rendering."]}),"\n",(0,l.jsxs)(i.li,{children:["\xe8 ",(0,l.jsx)(i.em,{children:"associativa e commutativa"}),", rendendo il risultato deterministico anche con calcoli in parallelo."]}),"\n"]}),"\n",(0,l.jsx)(i.h3,{id:"parallelizzazione-adattiva",children:"Parallelizzazione \u201cadattiva\u201d"}),"\n",(0,l.jsxs)(i.p,{children:["Il calcolo viene eseguito in parallelo ",(0,l.jsx)(i.em,{children:"solo quando \xe8 vantaggioso"}),", ovvero per griglie molto grandi o con molte luci. Le\nsoglie di attivazione sono configurabili.\nGrazie alla somma saturata, la riduzione parallela resta deterministica."]}),"\n",(0,l.jsx)(i.h3,{id:"interrogazione-del-campo-con-interpolazione",children:"Interrogazione del campo con interpolazione"}),"\n",(0,l.jsxs)(i.p,{children:["Il ",(0,l.jsx)(i.code,{children:"LightField"})," finale memorizza valori discreti per cella. Questo permettere ai sensori di leggere un valore di luce\nda una coordinata continua (",(0,l.jsx)(i.code,{children:"Point2D"}),"), utilizzando l'",(0,l.jsx)(i.em,{children:"interpolazione bilineare"})," (risultati fluidi e aliasing ridotto)."]}),"\n",(0,l.jsxs)(i.blockquote,{children:["\n",(0,l.jsxs)(i.p,{children:["Nota: fuori dai confini ritorna ",(0,l.jsx)(i.code,{children:"0.0"}),"."]}),"\n"]}),"\n",(0,l.jsxs)(i.h3,{id:"integrazione-con-environment",children:["Integrazione con ",(0,l.jsx)(i.code,{children:"Environment"})]}),"\n",(0,l.jsxs)(i.p,{children:["Nell'",(0,l.jsx)(i.code,{children:"Environment"})," il campo luminoso (",(0,l.jsx)(i.code,{children:"LightField"}),") \xe8 un ",(0,l.jsx)(i.code,{children:"lazy val"}),".\nDi conseguenza viene calcolato solo alla prima richiesta e il risultato viene messo in cache per tutta la vita dell'istanza."]}),"\n",(0,l.jsxs)(i.blockquote,{children:["\n",(0,l.jsxs)(i.p,{children:["Nota: se l'ambiente o le luci cambiano, il ",(0,l.jsx)(i.code,{children:"LightField"})," deve essere invalidato (non \xe8 gestito automaticamente)."]}),"\n"]}),"\n",(0,l.jsx)(i.admonition,{type:"info",children:(0,l.jsxs)(i.p,{children:["Per i dettagli e gli snippet di codice, vedi ",(0,l.jsx)(i.a,{href:"/PPS-22-srs/docs/implementation/david-cohen/illumination",children:"l'implementazione di Illumination"}),"."]})})]})}function m(e={}){const{wrapper:i}={...(0,s.R)(),...e.components};return i?(0,l.jsx)(i,{...e,children:(0,l.jsx)(d,{...e})}):d(e)}}}]);